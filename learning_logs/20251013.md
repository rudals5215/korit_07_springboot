# SpringBoot Project
1. https://start.spring.io 로 들어가서 프로젝트 생성 준비

2. 필요 의존성 추가한 후에 Generate하고
  - 다운 받아서 압축 풀고 springboot 폴더로 옮긴 다음에
  - intellij를 실행시켜서 프로젝트가 올바르게 생성됐는지를 체크합니다.
  - 현재 상황에서 대부분의 의존성을 제대로 체크했다고 하더라도 실행되지 않았습니다.
  - tododb라는 데이터베이스 자체가 없었기 떄문입니다.
  - 그래서 heidiSQL 켠 다음에 tododb를 생성해주고 springboot 애플리케이션을 실행했더니 spring security가 적용된 상태로 실행이 되었습니다.
```java
dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'org.springframework.boot:spring-boot-starter-web'

	compileOnly 'org.projectlombok:lombok'
	developmentOnly 'org.springframework.boot:spring-boot-devtools'
	annotationProcessor 'org.projectlombok:lombok'

	runtimeOnly 'org.mariadb.jdbc:mariadb-java-client'

	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.springframework.security:spring-security-test'
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

	implementation 'io.jsonwebtoken:jjwt-api:0.13.0'
	runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.13.0'
	runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.13.0'
}
```

3. properties 추가
```java
spring.application.name=demo
spring.datasource.url=jdbc:mariadb://localhost:3310/tododb
spring.datasource.username=root
spring.datasource.password=1234
spring.datasource.driver-class-name=org.mariadb.jdbc.Driver
spring.jpa.generate-ddl=true
spring.jpa.hibernate.ddl-auto=create-drop
```

4. domain 패키지에 Todo, User 클래스 생성
- Todo
```java
import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Entity
@Getter
@Setter
@NoArgsConstructor
public class Todo {

    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private Long id;

    @Column(nullable = false)
    private String content;

    private boolean isCompleted = false;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    @JsonIgnore
    private  User user;

    public Todo(String content, User user) {
        this.content = content;
        this.user = user;
    }
}
```

- User
```java
import jakarta.persistence.*;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.ArrayList;
import java.util.List;

@Entity
@Table(name = "users")
@Data
@NoArgsConstructor
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    @Column(nullable = false, updatable = false)
    private Long id;

    @Column(nullable = false, unique = true)
    private String username;

    @Column(nullable = false)
    private String password;

    @Column(nullable = false)
    private String role;

    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Todo> todos = new ArrayList<>();

    public User(String username, String password, String role) {
        this.username = username;
        this.password = password;
        this.role = role;
    }
}
```

5. TodoRepository, UserRepository 클래스 생성 후 JpaRepository extends하기
- TodoRepository
```java
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface TodoRepository extends JpaRepository<Todo, Long> {
    List<Todo> findByUserId(Long id);

    void deleteByUserAndIsCompleted(User currentUser, boolean isCompleted);
}
```
- UserRepository
```java
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByUsername(String username);
}
```

6. dto 패키지, TodoRequestDto or TodoRequestRecord클래스 생성
- TodoRequestDto
```java
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class TodoRequestDto {
    private String content;
}
```

- TodoRequestRecord
```java
public record TodoRequestRecord(String content) {
}
```

7. service 패키지, TodoService, UserDetailsServiceImpl 클래스 생성
- TodoService
```java

import com.todolist.demo.domain.Todo;
import com.todolist.demo.domain.TodoRepository;
import com.todolist.demo.domain.User;
import com.todolist.demo.domain.UserRepository;
import com.todolist.demo.dto.TodoRequestDto;
import com.todolist.demo.dto.TodoRequestRecord;
import jakarta.persistence.EntityNotFoundException;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
public class TodoService {

    private final UserRepository userRepository;
    private final TodoRepository todoRepository;

    public TodoService(UserRepository userRepository, TodoRepository todoRepository) {
        this.userRepository = userRepository;
        this.todoRepository = todoRepository;
    }

    private User getCurrentUser() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        String username = authentication.getName();
        return userRepository.findByUsername(username).orElseThrow(() -> new EntityNotFoundException("User를 찾을 수 없습니다."));
    }

    // 본인 확인 로직 (To-do 객체 내에 있는 User와, 지금 요청을 보내는 애가 동일한지를 확인하는 로직)
    private void checkOwnership(Todo todo) throws AccessDeniedException{
        if (!todo.getUser().equals(getCurrentUser())) {
            throw new AccessDeniedException("해당 todo에 접근할 수 없습니다.");
        }
    }

    // 1. 사용자 구분 없이 모든 할 일 목록 조회
    @Transactional      // 순서중 어긋나면 알아서 롤백
    public List<Todo> getTodos() {
        return todoRepository.findAll();
    }

    // 2. 현재 사용자의 모든 할 일 목록 조회
    @Transactional(readOnly = true)
    public List<Todo> getTodosForCurrentUser() {
        User currentUser = getCurrentUser();
        return todoRepository.findByUserId(currentUser.getId());
    }

    // 3. 새로운 to-do 추가
    // DTO version
    public Todo createTodo(TodoRequestDto todoRequestDto) {
        User currentUser = getCurrentUser();
        Todo newTodo = new Todo(todoRequestDto.getContent(), currentUser);

        return todoRepository.save(newTodo);
    }

    // Record version
    public Todo createTodo2(TodoRequestRecord todoRequestRecord) {
        User currentUser = getCurrentUser();
        Todo newTodo = new Todo(todoRequestRecord.content(), currentUser);

        return todoRepository.save(newTodo);
    }

    // 4. 할 일 내용 수정
    @Transactional
    public Todo updateTodoContent(Long id, TodoRequestDto updateDto) throws AccessDeniedException {      // AccessDeniedException - 나의 것이 아닌 내용 수정 불가
        Todo todo = todoRepository.findById(id).orElseThrow(() -> new EntityNotFoundException("해당 id를 가진 todo가 없습니다. id : " + id));
        checkOwnership(todo);
        todo.setContent(updateDto.getContent());
        return todoRepository.save(todo);
    }

    // 5. 할 일 삭제
    @Transactional
    public void deleteTodo(Long id) throws AccessDeniedException {
        Todo todo = todoRepository.findById(id).orElseThrow(() -> new EntityNotFoundException("해당 id를 가진 todo가 없습니다. id : " + id));
        checkOwnership(todo);
        todoRepository.delete(todo);
    }

    // 6. 할 일 완료 상태 토글
    @Transactional
    public Todo toggleTodoStatus(Long id) throws AccessDeniedException {
        Todo todo = todoRepository.findById(id).orElseThrow(() -> new EntityNotFoundException("해당 id를 가진 todo가 없습니다. id : " + id));
        checkOwnership(todo);
        todo.setCompleted(!todo.isCompleted());
        return todoRepository.save(todo);
    }

    // 7. 완료된 할 일 전체 삭제하는 로직
    @Transactional
    public void clearCompletedTodos() {
        User currentUser = getCurrentUser();
        todoRepository.deleteByUserAndIsCompleted(currentUser, true);
    }
}
```

- UserDetailsServiceImpl
```java
import com.todolist.demo.domain.User;
import com.todolist.demo.domain.UserRepository;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.Optional;

@Service
public class UserDetailsServiceImpl implements UserDetailsService {
    private final UserRepository userRepository;

    public UserDetailsServiceImpl(UserRepository userRepository) {
        this.userRepository = userRepository;
    }

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {

        Optional<User> user = userRepository.findByUsername(username);
        org.springframework.security.core.userdetails.User.UserBuilder builder = null;
        if (user.isPresent()) {
            User currentUser = user.get();      // User타입으로 형변환
            builder = org.springframework.security.core.userdetails.User.withUsername(username);
            builder.password(currentUser.getPassword());
            builder.roles(currentUser.getRole());
        } else {
            throw new UsernameNotFoundException("해당 User를 찾을 수 없습니다.");
        }
        return builder.build();
    }
}
```

8. web 패키지, TodoController 클래스 생성
- TodoController
```java
import com.todolist.demo.domain.Todo;
import com.todolist.demo.dto.TodoRequestDto;
import com.todolist.demo.service.TodoService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/todos")
public class TodoController {
    private final TodoService todoService;

    public TodoController(TodoService todoService) {
        this.todoService = todoService;
    }

    @GetMapping
    public ResponseEntity<List<Todo>> getTodos() {
        return ResponseEntity.ok(todoService.getTodosForCurrentUser());
    }

    @PostMapping
    public ResponseEntity<Todo> createTodo(@RequestBody TodoRequestDto requestDto) {
        Todo createdTodo = todoService.createTodo(requestDto);
        return new ResponseEntity<>(createdTodo, HttpStatus.CREATED);
    }

    // 수정 / 삭제 파트에 해당하는 Controller 단계에서의 메서드 정의
    // 지금 수정 / 삭제 파트에서 DB에 있는 데이터를 수정 / 삭제 하는 로직은 TodoService에 정의되어 있습니다.
    @PutMapping("/{id}")
    public ResponseEntity<Todo> updateTodo(@PathVariable Long id, @RequestBody TodoRequestDto updateDto) throws AccessDeniedException {
        return ResponseEntity.ok(todoService.updateTodoContent(id, updateDto));
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteTodo(@PathVariable Long id) throws AccessDeniedException {
        todoService.deleteTodo(id);
        return ResponseEntity.noContent().build();
    }

    // 토글 관련 메서드 정의
    @PatchMapping("/{id}/toggle")
    public ResponseEntity<Todo> toggleTodoStatus(@PathVariable Long id) throws AccessDeniedException {
        return ResponseEntity.ok(todoService.toggleTodoStatus(id));
    }

    // 일괄 삭제
    @DeleteMapping("/completed")
    public ResponseEntity<Void> clearCompletedTodos() {
        todoService.clearCompletedTodos();
        return ResponseEntity.noContent().build();
    }

}
```

9. 
