````markdown
# Spring Boot MVC 정리 — CORS, Role 기반 보호, 테스트, CRUD 확장 (Car Database 예제)

> **학습 흐름**  
> MVC 개념 → Spring MVC 요청 흐름 → 프로젝트 셋업/이슈 → Service/Controller 구성 → CORS Filter → Role 기반 보호 → 테스트 전략 → 함수형 유틸(.map) → CRUD 실습/확장  
> 깃허브/벨로그에 **그대로 복붙** 가능합니다. (코드 원문 유지)

---

## 1) MVC Pattern

- **정의**: 애플리케이션을 **Model / View / Controller** 로 분리하는 설계 방식  
- **목표**: 비즈니스 로직, 화면 표시, 제어 로직을 **명확히 분리**해 유지보수/테스트성/병렬 개발성 향상

### 구성 요소
- **Model**  
  - 데이터/비즈니스 로직 담당(저장/조회/변경 등)  
  - Spring Boot에서 `Service`, `Repository(DAO)`, `DTO/Entity` 등
- **View**  
  - 데이터를 **시각화**하여 표시, 사용자 입력 수신  
  - Spring Boot: Thymeleaf/JSP, 또는 **REST(JSON/XML)** 응답 (우리는 React 연동 예정)
- **Controller**  
  - 사용자의 요청 수신 → Model 호출 → 적절한 View로 응답  
  - Spring Boot: `@Controller`, `@RestController`, `@RequestMapping` 등

---

## 2) Spring MVC 동작 원리

- **DispatcherServlet**(프론트 컨트롤러): 모든 HTTP 요청을 가장 먼저 받아 처리
- **요청 처리 단계**
  1. **요청 수신**: 예) `GET /users/1`
  2. **핸들러 매핑**: URL에 맞는 Controller 메서드 탐색
  3. **Controller 실행**: Service/Repository 호출 등 비즈니스 로직 수행
  4. **Model/뷰 이름 반환**: `ModelAndView` 또는 View 이름/Model 데이터
  5. **View 해석**: ViewResolver가 실제 뷰 결정
  6. **렌더링 → 응답**: View가 최종 응답 생성하여 반환

---

## 3) Spring Boot 3.5.6 예시 (Controller/Service/View)

> (코드 원문 그대로 유지)

```java
@Controller   // 해당 클래스가 Controller임을 선언
public class UserController {
  private final UserService userService;  // Model 계층과의 상호작용을 위한 Service를 주입(Injection)

  // 생성자 주입
  public UserController(UserService userSerbice) {
    this.userService = userService;
  }

  // GET 요청으로  /users/123
  @GetMapping("/users/{userId}")
  public String getUserDetail(@PathVariable Long userId, Model model){
    // 1. Controller는 Model(Service)에 데이터 처리를 요청
    User user = userService.findUserByUd(userId);

    // 2. Controller는 Model 데이터를 View에 전달하기 위해 Model 객체를 담음
    model.addAttribute("user",user);
    model.addAttribute("pageTitle","사용자 상세 정보");

    // 3. Controller는 View의 논리적 이름을 return
    // : (VIewResolver가 'user-detail'에 해당하는 템플릿을 찾음)
    return "user-detail";
  }
}
````

```java
@Service    // 해당 클래스가 Service(Model)임을 명시
public class UserService{
  private final UserRepository userRepository;

  public userService(UserRepository userRepository) {
    this.userRepository = userRepository;
  }

  public User findUserById(Long id) {
    // UserRepository에서 담겨있는 DB를 조회해서 Java에서 쓸 수 있도록 해야곘네요.
    User user = userRepository.findById(id);
    if(id == user.getId()){
      return user;
    }
    return null;
  }
}
```

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${pageTitle}">사용자 상세</title> 
</head>
<body>
    <h1>사용자 상세 정보</h1>
    
    <p>ID: <span th:text="${user.id}">123</span></p>
    <p>이름: <span th:text="${user.name}">김철수</span></p>
    <p>이메일: <span th:text="${user.email}">chulsoo@email.com</span></p>
    
    <a href="/">돌아가기</a>
</body>
</html>
```

---

## 4) 새 프로젝트(cardatabase_4) 생성 & 초기 이슈

* **Spring Initializr**: Spring Web / DevTools / Lombok 추가
* **자주 발생 이슈**

  1. `JpaRepository` 미인식 → `spring-boot-starter-data-jpa` 의존성 추가 후 **코끼리(동기화)**
  2. `Owner` 참조 오류 → `Owner`/`OwnerRepository` 먼저 생성
  3. DB 연결/설정 누락 → `application.properties`, MariaDB 드라이버 의존성 추가
  4. 실행 OK → HeidiSQL에서 `SELECT * FROM car;` (Row=0 테이블 확인)
  5. Controller 미작성 상태면 Postman으로는 아직 CRUD 불가

---

## 5) Service/Controller 구성 (Car 예시)

> (코드 원문 그대로 유지)

**CarService.java**

```java
package com.example.cardatabased4.service;

import com.example.cardatabased4.domain.Car;
import com.example.cardatabased4.domain.CarRepository;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class CarService {
    private final CarRepository carRepository;

    public CarService(CarRepository carRepository) {
        this.carRepository = carRepository;
    }

    // 모든 자동차 목록을 조회한다고 가정하겠습니다.
    public List<Car> getCars() {
        return carRepository.findAll();
    }
}
```

```java
// 새로운 자동차 저장
public Car addCar(Car car) {
    return carRepository.save(car);
}
```

**CarController.java**

```java
package com.example.cardatabased4.web;

import com.example.cardatabased4.domain.Car;
import com.example.cardatabased4.service.CarService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api")
public class CarController {
    private final CarService carService;

    public CarController(CarService carService) {
        this.carService = carService;
    }

    // 1. 모든 자동차 정보 조회 (GET /api/cars)
    @GetMapping("/cars")
    public List<Car> getCars() {
        return carService.getCars();
    }

    // 2. 차량 한 대 추가(POST /api/cars)
    @PostMapping("/cars")
    public ResponseEntity<Car> addCar(@RequestBody Car car) {
        Car savedCar = carService.addCar(car);

        return new ResponseEntity<>(savedCar, HttpStatus.CREATED);
    }
}
```

---

## 6) CORS Filter 추가

> (코드 원문 그대로 유지)

**CORS Bean**

```java
@Bean
  public CorsConfigurationSource corsConfigurationSource() {
      UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
      CorsConfiguration config = new CorsConfiguration();
      config.setAllowedOrigins(Arrays.asList("*"));
      config.setAllowedMethods(Arrays.asList("*"));
      config.setAllowedHeaders(Arrays.asList("*"));

      config.setAllowCredentials(false);
      config.applyPermitDefaultValues();


      source.registerCorsConfiguration("/**", config);
      return source;
  }
```

**특정 Origin만 허용**

```
config.setAllowOrigins(Arrays.asList("http://localhost:5173","http://localhost:3000"))
```

**SecurityFilterChain에 적용**

```java
import static org.springframework.security.config.Customizer.withDefaults;

@Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf(csrf ->csrf.disable())
                .cors(withDefaults())       // 여기 추가했습니다. 근데 static 메서드 추가하는 import문도 추가됨 특정 port만 열리게 하는 설정
                .sessionManagement(sessionManagement -> sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(authorizeHttpRequests -> authorizeHttpRequests.requestMatchers(HttpMethod.POST,"/login").permitAll().anyRequest().authenticated())
                .addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class)
                .exceptionHandling(exceptionHandling -> exceptionHandling.authenticationEntryPoint(exceptionHandler));
        return http.build();
    }
```

---

## 7) Role-Based Protection (예시)

> (코드 원문 그대로 유지 — 프로젝트에는 도입 X)

```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
  http.csrf(csrf ->csrf.disable())
          .cors(withDefaults())
          .sessionManagement(sessionManagement -> sessionManagement.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
          .authorizeHttpRequests(authorizeHttpRequests -> authorizeHttpRequests.requestMatchers("/admin/**").hasRole("ADMIN").requestMatchers("/user/**").hasRole("USER").anyRequest().authenticated())
          .addFilterBefore(authenticationFilter, UsernamePasswordAuthenticationFilter.class)
          .exceptionHandling(exceptionHandling -> exceptionHandling.authenticationEntryPoint(exceptionHandler));
  return http.build();
}
```

---

## 8) 백엔드 테스트 (요약)

* `spring-boot-starter-test` (JUnit/Mockito/AssertJ)
* H2 인메모리 DB 사용 권장:

  ```
  testRuntimeOnly 'com.h2database:h2'
  ```
* `@SpringBootTest`: 전체 컨텍스트 로드
* `@DataJpaTest`: JPA 슬라이스 (H2/SQL 로깅 강화)
* `@WebMvcTest`: 웹 레이어만, `MockMvc`로 엔드포인트 테스트

> (본문에 다양한 예시 포함 — 그대로 참조)

---

## 9) 함수형 유틸 — `.map()` 요약

* **목적**: 컨테이너 내부 요소 변환(새 컨테이너 반환), 원본 불변
* **주요 대상**: `Stream<T>`, `Optional<T>`
* **예시**:

  * Stream: `numbers.stream().map(n -> n*n).collect(...)`
  * Optional: `findUser(...).map(User::getEmail).orElse("N/A")`

> (코드 원문 그대로 유지)

---

## 10) CRUD 실습 플로우(삭제 포함)

> 1. **POST** 로 Car 추가
> 2. **GET** 으로 저장 확인
> 3. **DELETE** 로 삭제 → `204 No Content`

* **20250929 15:39 기준**: Car 기반 CRUD 구현/검증 완료 (DBMS, Postman 확인)
* **과제**: **Owner 기준 CRUD 전체 구현**

  * Service/Controller에 **전체 조회 / ID 조회 / 추가 / 삭제 / 수정** 추가

---

## 11) 부록 — JJWT 0.13.0 / Record / Optional (발췌)

* **JJWT 0.13.0 의존성**

```java
// jjwt 관련 설정
implementation 'io.jsonwebtoken:jjwt-api:0.13.0'
runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.13.0'
runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.13.0'
```

* **토큰 발급 메서드 (원문)**

```java
// 서명이 이루어진 JWT 토큰을 생성
public String getToken(String username) {
    String token = Jwts.builder()
            .setSubject(username)
            .setExpiration(new Date(System.currentTimeMillis() + EXPIRATIONTIME))
            .signWith(key)          // 18번 라인에 생성한 비밀 키로 서명
            .compact();
    return token;
}
```

* **Record (AccountCredentials)**

```java
package com.example.cardatabase.domain;

public record AccountCredentials(String username, String password) {}
```

* **Optional 사용 패턴**
  (원문 예시/설명 유지 — `isPresent()`, `get()`, `orElse`, `orElseGet`, `ifPresent` 등)

---

## 12) 체크리스트

* [ ] MVC 흐름: Controller ↔ Service ↔ Repository 구조화
* [ ] DB/의존성/프로퍼티 설정 후 실행(테이블 생성 확인)
* [ ] CORS 필터 등록 + `.cors(withDefaults())` 활성화
* [ ] (필요 시) 특정 Origin만 허용
* [ ] Role 기반 보호(요청/메서드 수준) 설계
* [ ] H2 기반 테스트: `@DataJpaTest`, `@WebMvcTest`, `@SpringBootTest` 분리 사용
* [ ] Car CRUD Postman 검증 → **Owner CRUD 확장 구현**

---

```
```
